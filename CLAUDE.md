# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Lighter Python SDK - Python client library for the Lighter decentralized exchange platform. This SDK provides API clients for interacting with zkLighter trading services, including perpetual and spot markets, along with transaction signing capabilities through native CGO binaries.

## Architecture

### Core Components

1. **API Client Layer** (`lighter/api/`)
   - Auto-generated from OpenAPI spec (see `openapi.json`)
   - Async HTTP client using aiohttp
   - Main APIs: `AccountApi`, `OrderApi`, `TransactionApi`, `CandlestickApi`, `BlockApi`
   - Entry point: `lighter.ApiClient` with `lighter.Configuration`

2. **Signer Client** (`lighter/signer_client.py`)
   - High-level trading client wrapping both API and signing functionality
   - Uses platform-specific native libraries (CGO binaries in `lighter/signers/`)
   - Handles transaction signing via ctypes interface to Go shared libraries
   - Includes nonce management for transaction ordering
   - Main methods: `create_order()`, `modify_order()`, `cancel_order()`, `withdraw()`, `transfer()`

3. **Native Signer Libraries** (`lighter/signers/`)
   - Pre-compiled CGO binaries for cryptographic operations
   - Platform support: Darwin ARM64, Linux AMD64/ARM64, Windows AMD64
   - Loaded via ctypes based on platform detection
   - Handles API key generation and transaction signing

4. **Nonce Manager** (`lighter/nonce_manager.py`)
   - Two strategies: `OptimisticNonceManager` (local increment) and `ApiNonceManager` (fetch from API)
   - Manages nonce sequencing for transactions across multiple API keys
   - Round-robin cycling through API keys for concurrent transaction support

5. **WebSocket Client** (`lighter/ws_client.py`)
   - Real-time subscriptions for order books and account updates
   - Supports both sync (`websockets.sync.client`) and async modes
   - Maintains local state for order books and accounts

6. **Transaction Types** (`lighter/transactions/`)
   - Data models: `CreateOrder`, `CancelOrder`, `Withdraw`, `CreateGroupedOrders`
   - Used for serialization between Python and native signer

## Common Commands

### Development
```bash
# Install dependencies
pip install -r requirements.txt
pip install -r test-requirements.txt

# Run tests (excludes auto-generated API files)
pytest --ignore-glob="*api.py"

# Linting
flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

# Type checking
mypy lighter
```

### Setup for Trading
```bash
# Initial setup - generates API keys and saves to api_key_config.json
python examples/system_setup.py

# Update BASE_URL, ETH_PRIVATE_KEY, and API_KEY_INDEX in system_setup.py before running
```

### Running Examples
```bash
# Read-only operations (no auth required)
python examples/get_info.py

# WebSocket streaming
python examples/ws.py

# Trading examples (requires setup)
python examples/create_modify_cancel_order_http.py
python examples/create_market_order_eth_buy.py
python examples/spot_get_order_books.py
```

## Key Patterns

### Client Initialization
- API-only: Create `lighter.ApiClient()` with optional `Configuration`
- Trading: Create `lighter.SignerClient()` with account index, API keys, and private key
- SignerClient includes an embedded ApiClient for read operations

### Transaction Flow
1. Get nonce: `api_key_index, nonce = client.nonce_manager.next_nonce()`
2. Call transaction method (e.g., `create_order()`) with nonce and api_key_index
3. Transaction is signed by native library and submitted via HTTP or WebSocket
4. Returns tuple: `(tx_object, tx_hash, error)`

### Market Indices
- Perpetual markets: 0-2047 (ETH perp = 0)
- Spot markets: 2048+ (spot ETH = 2048)
- Get market details via `OrderApi.order_books()` or examples

### Amount/Price Precision
- Amounts in smallest units (e.g., 1000 = 0.1 ETH with 4 decimals)
- Prices as integers with 2 decimal precision (e.g., 4050_00 = $4050.00)
- Use `transfer()` wrapper for decimal handling, or `sign_transfer()` for manual control

### API Authentication
- Uses Ed25519 API key pairs generated via `lighter.create_api_key()`
- Keys stored in `api_key_config.json` by setup script
- Each transaction requires api_key_index and nonce
- Ethereum private key only used for API key registration (signed message), not for trading

## Important Notes

- **Code Generation**: Most API code is auto-generated from OpenAPI spec. Do not manually edit files with "Generated by OpenAPI Generator" headers.
- **Platform Dependencies**: The native signer libraries are platform-specific. Ensure the correct binary exists in `lighter/signers/` for the target platform.
- **Async Required**: All trading operations are async. Use `asyncio.run()` or `await` in async context.
- **Testnet vs Mainnet**: Change `BASE_URL` in examples or `Configuration.host` to switch environments:
  - Testnet: `https://testnet.zklighter.elliot.ai`
  - Mainnet: `https://mainnet.zklighter.elliot.ai`
- **Nonce Management**: Use the same `api_key_index` for sequential transactions to ensure ordering. Different keys can be used for parallel transactions.
- **Error Handling**: Transaction methods return errors as third tuple element. Always check `if err is not None`.

## Testing

- Hand-written tests go in `tests/` (included in mypy)
- Auto-generated tests in `test/` are excluded from pytest runs
- Use `pytest --ignore-glob="*api.py"` to skip generated API files
- CI runs on Python 3.8, 3.9, 3.10, 3.11

## Configuration Files

- `pyproject.toml`: Poetry packaging config, mypy settings
- `setup.py`: Setuptools config (build backend)
- `openapi.json`: OpenAPI spec source for code generation
- `api_key_config.json`: Generated by setup script, stores API keys (gitignored)
